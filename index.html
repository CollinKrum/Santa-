<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7145940911173373" crossorigin="anonymous"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Santa's Command Center</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(to bottom right, #450a0a, #7f1d1d, #14532d);
      min-height: 100vh; color: white; padding: 20px;
    }
    @keyframes wiggle { 0%,100%{transform:rotate(0)} 25%{transform:rotate(-5deg)} 75%{transform:rotate(5deg)} }
    @keyframes float { 0%{transform:translateY(-100px) translateX(0);opacity:0} 50%{transform:translateY(50vh) translateX(30px);opacity:.2} 100%{transform:translateY(110vh) translateX(0);opacity:0} }
    .snowflake { position: fixed; top: -50px; color: white; font-size: 20px; opacity: .2; pointer-events:none; animation: float linear infinite; z-index:1; }
    .container { max-width: 980px; margin: 0 auto; position: relative; z-index: 10; }
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { font-size: clamp(32px, 5vw, 48px); font-weight: bold; margin-bottom: 8px; }
    .santa-icon { display: inline-block; font-size: 64px; animation: wiggle 2s ease-in-out infinite; }
    .subtitle { color: #fecaca; font-size: 18px; }
    .card { background: rgba(255,255,255,.1); backdrop-filter: blur(10px); border-radius: 24px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,.5); }
    .name-input-section { background: linear-gradient(to right, #dc2626, #ef4444, #16a34a); padding: 24px; }
    .name-input-section label { display:block; color:white; font-size:12px; font-weight:700; letter-spacing:1px; margin-bottom:12px; }
    .name-input-section input { width:100%; padding:16px 20px; border-radius:16px; border:none; font-size:18px; outline:none; }
    .tabs { display:flex; background: rgba(255,255,255,.05); border-bottom:1px solid rgba(255,255,255,.1); overflow:auto; }
    .tab { flex:1; padding:20px; text-align:center; cursor:pointer; background:transparent; border:none; color:rgba(255,255,255,.7); font-size:14px; font-weight:600; transition:.2s; position:relative; white-space:nowrap; }
    .tab:hover{ color:#fff; }
    .tab.active{ color:#fff; background: rgba(255,255,255,.1); }
    .tab.active::after{ content:''; position:absolute; bottom:0; left:0; right:0; height:3px; background: linear-gradient(to right, #dc2626, #16a34a); border-radius:3px 3px 0 0; }
    .tab-icon{ display:block; font-size:24px; margin-bottom:4px; }
    .tab-content{ padding:24px; min-height: 520px; }
    .tab-pane{ display:none; }
    .tab-pane.active{ display:block; }

    .message-buttons{ display:flex; flex-direction:column; gap:12px; }
    .message-btn{ display:flex; justify-content:space-between; align-items:center; padding:20px; border-radius:16px; border:none; font-size:16px; font-weight:700; color:white; cursor:pointer; transition:transform .2s; position:relative; }
    .message-btn:hover:not(:disabled){ transform:scale(1.05); }
    .message-btn:active:not(:disabled){ transform:scale(.98); }
    .message-btn:disabled{ opacity:.6; cursor:not-allowed; transform:none !important; }
    .message-btn.nice{ background:linear-gradient(135deg,#10b981,#059669); }
    .message-btn.naughty{ background:linear-gradient(135deg,#ef4444,#dc2626); }
    .message-btn.neutral{ background:linear-gradient(135deg,#3b82f6,#2563eb); }

    .speaking-indicator{ margin-top:16px; padding:16px; background:linear-gradient(135deg,#dc2626,#16a34a); border-radius:16px; text-align:center; font-weight:bold; animation:pulse 1.5s ease-in-out infinite; }
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
    .generate-btn{ width:100%; padding:24px; border-radius:16px; border:none; background:linear-gradient(135deg,#dc2626,#ef4444,#16a34a); color:white; font-size:18px; font-weight:bold; cursor:pointer; margin-bottom:24px; transition:transform .2s; }
    .generate-btn:hover{ transform:scale(1.05); }

    .report-card{ background:white; color:#1f2937; border-radius:20px; overflow:hidden; }
    .report-header{ background:linear-gradient(135deg,#dc2626,#16a34a); color:white; padding:24px; text-align:center; }
    .report-content{ padding:24px; }
    .report-scores{ display:grid; grid-template-columns:1fr 1fr; gap:16px; margin:20px 0; }
    .score-box{ padding:20px; border-radius:16px; text-align:center; }
    .score-box.nice{ background:#d1fae5; }
    .score-box.naughty{ background:#fee2e2; }
    .score-number{ font-size:48px; font-weight:bold; }
    .deeds-section{ background:#f3f4f6; padding:16px; border-radius:12px; margin:16px 0; }

    .cam-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    @media (min-width:640px){ .cam-grid{ grid-template-columns: repeat(3, 1fr); }}
    .cam-button{ padding:20px; border-radius:16px; border:none; color:white; font-weight:bold; cursor:pointer; transition:transform .2s; text-align:center; }
    .cam-button:hover{ transform:scale(1.05); }
    .cam-emoji{ font-size:40px; display:block; margin-bottom:8px; }
    .cam-title{ font-size:14px; display:block; }

    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.9); z-index:1000; padding:20px; }
    .modal.open{ display:flex; align-items:center; justify-content:center; }
    .modal-content{ width:100%; max-width:1000px; background:#000; border-radius:16px; overflow:hidden; }
    .modal-header{ display:flex; justify-content:space-between; align-items:center; padding:16px; background:#1f1f1f; }
    .close-btn{ background:#dc2626; color:white; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; font-weight:bold; }
    .video-container{ background:#000; display:flex; align-items:center; justify-content:center; min-height:400px; }
    .video-container video{ width:100%; max-height:80vh; object-fit:contain; display:block; }
    .video-controls{ padding:16px; background:#1f1f1f; display:flex; gap:12px; justify-content:center; }
    .control-btn{ background:#374151; color:white; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; font-weight:600; font-size:14px; }
    .control-btn:hover{ background:#4b5563; }

    .footer{ text-align:center; margin-top:40px; opacity:.6; font-size:14px; }

    /* Letters to Santa styles */
    .letter-grid{ display:grid; gap:16px; grid-template-columns:1fr; }
    @media(min-width:900px){ .letter-grid{ grid-template-columns: 1.1fr .9fr; } }
    .field{ display:flex; flex-direction:column; gap:8px; }
    .field label{ font-size:12px; letter-spacing:.08em; font-weight:800; opacity:.9; }
    .input, .textarea{
      background: rgba(255,255,255,.9); color:#111827; border:none; border-radius:14px; padding:14px 16px; font-size:16px; outline:none;
    }
    .textarea{ min-height:180px; resize:vertical; }
    .pill-row{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{ background: rgba(255,255,255,.85); color:#111827; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; }
    .hint{ font-size:12px; opacity:.85; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .btn{ background:#16a34a; border:none; color:white; font-weight:800; padding:12px 16px; border-radius:12px; cursor:pointer; }
    .btn.secondary{ background:#2563eb; }
    .btn.ghost{ background:transparent; border:1px solid rgba(255,255,255,.3); }
    .counter{ font-size:12px; opacity:.8; text-align:right; }
    .preview{
      background: #faf7e8; color:#2b2b2b; border-radius:16px; padding:18px; min-height:240px; position:relative; box-shadow: inset 0 0 0 2px rgba(0,0,0,.05);
      background-image: linear-gradient(to bottom, rgba(0,0,0,.04) 1px, transparent 1px);
      background-size: 100% 28px; /* notebook lines */
    }
    .preview h3{ margin-bottom:8px; color:#7c2d12; }
    .preview small{ color:#6b7280; }
    .letter-list{ margin-top:16px; display:flex; flex-direction:column; gap:10px; }
    .letter-item{ background: rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.15); border-radius:12px; padding:10px 12px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .letter-item b{ font-size:14px; }
  </style>
</head>
<body>
  <div id="snowflakes"></div>
  <div class="container">
    <div class="header">
      <div style="position: relative; display: inline-block;">
        <span class="santa-icon">üéÖ</span>
        <span style="position: absolute; top: -10px; right: -10px; font-size: 32px;">‚ú®</span>
      </div>
      <h1>Santa's Command Center</h1>
      <p class="subtitle">Live from the North Pole ‚Ä¢ Powered by ElevenLabs AI</p>
    </div>

    <div class="card">
      <!-- Name Input -->
      <div class="name-input-section">
        <label>CHILD'S NAME</label>
        <input type="text" id="childName" placeholder="Enter name here..." />
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab(event,'soundboard')">
          <span class="tab-icon">üîä</span>
          <span>Soundboard</span>
        </button>
        <button class="tab" onclick="switchTab(event,'report')">
          <span class="tab-icon">üìÑ</span>
          <span>Report Card</span>
        </button>
        <button class="tab" onclick="switchTab(event,'cam')">
          <span class="tab-icon">üìπ</span>
          <span>Santa Cam</span>
        </button>
        <button class="tab" onclick="switchTab(event,'letter')">
          <span class="tab-icon">‚úçÔ∏è</span>
          <span>Letter to Santa</span>
        </button>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Soundboard -->
        <div id="soundboard" class="tab-pane active">
          <div class="message-buttons" id="messageButtons"></div>
          <div id="speakingIndicator" style="display:none" class="speaking-indicator">üîä Santa is speaking...</div>
        </div>

        <!-- Report Card -->
        <div id="report" class="tab-pane">
          <button class="generate-btn" onclick="generateReport()">‚ú® Generate Report Card</button>
          <div id="reportResult"></div>
        </div>

        <!-- Santa Cam -->
        <div id="cam" class="tab-pane">
          <div class="cam-grid">
            <button class="cam-button" style="background:linear-gradient(135deg,#d97706,#ea580c);" onclick="openCam('workshop')"><span class="cam-emoji">üéÅ</span><span class="cam-title">Workshop</span></button>
            <button class="cam-button" style="background:linear-gradient(135deg,#dc2626,#991b1b);" onclick="openCam('office')"><span class="cam-emoji">üìã</span><span class="cam-title">Office</span></button>
            <button class="cam-button" style="background:linear-gradient(135deg,#475569,#334155);" onclick="openCam('stable')"><span class="cam-emoji">ü¶å</span><span class="cam-title">Stable</span></button>
            <button class="cam-button" style="background:linear-gradient(135deg,#ec4899,#be185d);" onclick="openCam('kitchen')"><span class="cam-emoji">üç™</span><span class="cam-title">Kitchen</span></button>
            <button class="cam-button" style="background:linear-gradient(135deg,#2563eb,#1e40af);" onclick="openCam('mailroom')"><span class="cam-emoji">‚úâÔ∏è</span><span class="cam-title">Mail Room</span></button>
            <button class="cam-button" style="background:linear-gradient(135deg,#059669,#047857);" onclick="openCam('lab')"><span class="cam-emoji">üß∏</span><span class="cam-title">Toy Lab</span></button>
          </div>
        </div>

        <!-- Letter to Santa -->
        <div id="letter" class="tab-pane">
          <div class="letter-grid">
            <div>
              <div class="field">
                <label for="letterFrom">FROM</label>
                <input id="letterFrom" class="input" type="text" placeholder="Child's name" />
              </div>
              <div style="height:10px"></div>
              <div class="field">
                <label for="wishlist">WISHLIST (optional)</label>
                <input id="wishlist" class="input" type="text" placeholder="e.g., Lego set, story books, warm socks" />
                <div class="hint">Tip: separate items with commas</div>
              </div>
              <div style="height:10px"></div>
              <div class="field">
                <label for="letterBody">YOUR LETTER</label>
                <textarea id="letterBody" class="textarea" maxlength="1200" placeholder="Dear Santa,\nThis year I have...\n"></textarea>
                <div class="counter"><span id="charCount">0</span>/1200</div>
              </div>
              <div class="actions">
                <button class="btn" onclick="saveLetter()">Save locally</button>
                <button class="btn secondary" onclick="downloadLetter()">Download .txt</button>
                <button class="btn ghost" onclick="printLetter()">Print</button>
                <button class="btn ghost" onclick="shareLetter()">Share</button>
              </div>
              <div class="hint" style="margin-top:10px">Letters are saved only on this device (local storage). No data leaves your browser.</div>
            </div>

            <div>
              <div class="preview" id="letterPreview">
                <h3>Dear Santa,</h3>
                <p style="white-space:pre-wrap; line-height:28px; font-size:16px;">Write your letter on the left to see a preview here.</p>
                <div style="margin-top:16px">
                  <small><b>From:</b> <span id="previewFrom">‚Äî</span></small><br>
                  <small><b>Wishlist:</b> <span id="previewWishlist">‚Äî</span></small>
                </div>
              </div>
              <div class="letter-list" id="lettersList"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      Made with holiday magic & Christmas spirit<br>¬© 2024 North Pole Technologies
    </div>
  </div>

  <!-- Video Modal -->
  <div id="videoModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span id="modalTitle">Santa Cam</span>
        <button class="close-btn" onclick="closeModal()">Close</button>
      </div>
      <div class="video-container"><video id="modalVideo" autoplay loop playsinline></video></div>
      <div class="video-controls">
        <button class="control-btn" id="muteBtn" onclick="toggleMute()">üîä Unmute</button>
        <button class="control-btn" onclick="restartVideo()">‚Üª Restart</button>
      </div>
    </div>
  </div>

  <script>
    // Global state
    let currentAudio = null;

    // Snowflakes
    const snowflakesContainer = document.getElementById('snowflakes');
    for (let i = 0; i < 20; i++) { const s = document.createElement('div'); s.className='snowflake'; s.textContent='‚ùÑ'; s.style.left=Math.random()*100+'%'; s.style.animationDelay=Math.random()*5+'s'; s.style.animationDuration=(Math.random()*10+15)+'s'; snowflakesContainer.appendChild(s); }

    // Tab switching (fix: pass event)
    function switchTab(ev, tabName){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
      ev.target.closest('.tab').classList.add('active');
      document.getElementById(tabName).classList.add('active');
    }

    // Soundboard
    const messages = [
      { text: "Ho ho ho! You've been very good today, {name}!", type: "nice", emoji: "üéÖ" },
      { text: "{name}, you're on the nice list this year!", type: "nice", emoji: "‚≠ê" },
      { text: "Wonderful job, {name}! Keep up the good work!", type: "nice", emoji: "üåü" },
      { text: "Santa sees you being kind, {name}!", type: "nice", emoji: "üíö" },
      { text: "{name}, I'm watching you... heading towards the naughty list!", type: "naughty", emoji: "üëÄ" },
      { text: "Ho ho... oh no, {name}! Better watch out!", type: "naughty", emoji: "‚ö†Ô∏è" },
      { text: "{name}, that behavior might get you coal for Christmas!", type: "naughty", emoji: "ü™®" },
      { text: "Careful, {name}! You're skating on thin ice!", type: "naughty", emoji: "‚ùÑÔ∏è" },
      { text: "Merry Christmas, {name}! Have a magical holiday!", type: "nice", emoji: "üéÑ" },
      { text: "{name}, have you been naughty or nice this year?", type: "neutral", emoji: "üéÖ" }
    ];

    const messageButtonsContainer = document.getElementById('messageButtons');
    function updateButtonText(){
      const name = document.getElementById('childName').value.trim() || 'little one';
      document.querySelectorAll('.message-btn').forEach((btn, idx)=>{
        const msg = messages[idx]; const span = btn.querySelector('.btn-text');
        if(span){ span.innerHTML = msg.text.replace(/{name}/g, `<strong>${name}</strong>`); }
      });
      // keep letters FROM in sync
      const fromEl = document.getElementById('letterFrom');
      if(fromEl && (!fromEl.dataset.touched || fromEl.value === '')) { fromEl.value = name; updateLetterPreview(); }
    }

    messages.forEach(msg=>{
      const btn=document.createElement('button');
      btn.className=`message-btn ${msg.type}`;
      btn.innerHTML = `<span class="btn-text">${msg.text.replace(/{name}/g,'<strong>little one</strong>')}</span><span style="font-size:30px;">${msg.emoji}</span>`;
      btn.onclick = ()=>speakMessage(msg.text);
      messageButtonsContainer.appendChild(btn);
    });

    document.getElementById('childName').addEventListener('input', updateButtonText);

    async function speakMessage(text){
      const name = document.getElementById('childName').value.trim() || 'little one';
      const personalized = text.replace(/{name}/g, name);
      if(currentAudio){ currentAudio.pause(); currentAudio=null; }
      const buttons = document.querySelectorAll('.message-btn'); buttons.forEach(b=>b.disabled=true);
      const indicator = document.getElementById('speakingIndicator'); indicator.style.display='block';
      try {
        const res = await fetch('/api/santa-voice',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text: personalized }) });
        if(!res.ok) throw new Error(`API Error: ${res.status} - ${res.statusText}`);
        const blob = await res.blob(); const url = URL.createObjectURL(blob);
        currentAudio = new Audio(url);
        currentAudio.onended = ()=>{ indicator.style.display='none'; buttons.forEach(b=>b.disabled=false); currentAudio=null; };
        currentAudio.onerror = ()=>{ indicator.style.display='none'; buttons.forEach(b=>b.disabled=false); alert('Error playing audio'); };
        await currentAudio.play();
      } catch(err){ console.error(err); indicator.style.display='none'; buttons.forEach(b=>b.disabled=false); alert('Error generating Santa voice. Please try again.\n\n'+err.message); }
    }

    // Report Card
    function generateReport(){
      const name = document.getElementById('childName').value.trim() || 'this child';
      const niceScore = Math.floor(Math.random()*40)+60; const naughtyScore = 100-niceScore;
      const status = niceScore>=75 ? 'NICE LIST' : niceScore>=60 ? 'WATCH LIST' : 'NAUGHTY LIST';
      const statusEmoji = niceScore>=75 ? '‚≠ê' : niceScore>=60 ? '‚ö†Ô∏è' : 'üéÖ';
      const allGood=['Shared toys with siblings','Helped with chores without being asked','Was kind to classmates','Did homework on time','Cleaned their room','Said please and thank you','Helped a friend in need','Was respectful to adults','Took care of a pet','Made their bed every morning','Ate vegetables without complaining','Brushed teeth without reminders','Helped carry groceries','Shared snacks with others','Was patient while waiting','Used kind words','Helped set the dinner table','Picked up after themselves','Was a good sport in games','Showed empathy to others'];
      const allBad=['Argued with siblings','Didn\'t listen the first time','Left toys scattered around','Complained about bedtime','Forgot to do assigned chores','Talked back occasionally','Needed reminders to clean up','Interrupted adults talking','Was grumpy in the morning','Fought over screen time','Didn\'t finish dinner','Procrastinated on homework','Made excuses for mistakes','Whined about going outside','Refused to share sometimes','Was too rough with pets','Stayed up past bedtime','Complained about chores','Left wet towels on the floor','Needed multiple reminders'];
      const good=[...allGood].sort(()=>.5-Math.random()).slice(0,4);
      const bad=[...allBad].sort(()=>.5-Math.random()).slice(0, Math.floor(Math.random()*2)+2);
      document.getElementById('reportResult').innerHTML = `
        <div class="report-card">
          <div class="report-header">
            <div style="font-size:40px; margin-bottom:8px;">üéÑ</div>
            <h2 style="font-size:24px; font-weight:bold;">OFFICIAL SANTA REPORT</h2>
            <p style="font-size:14px; margin-top:4px;">North Pole ‚Ä¢ ${new Date().toLocaleDateString()}</p>
          </div>
          <div class="report-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
              <h3 style="font-size:24px; font-weight:bold;">${name}</h3>
              <span style="background:${status.includes('NICE')?'#10b981':status.includes('WATCH')?'#fbbf24':'#ef4444'}; color:white; padding:8px 16px; border-radius:20px; font-weight:bold; font-size:12px;">${statusEmoji} ${status}</span>
            </div>
            <div class="report-scores">
              <div class="score-box nice"><div class="score-number" style="color:#059669;">${niceScore}%</div><div style="font-size:14px; font-weight:600; color:#059669;">Nice Score</div></div>
              <div class="score-box naughty"><div class="score-number" style="color:#dc2626;">${naughtyScore}%</div><div style="font-size:14px; font-weight:600; color:#dc2626;">Naughty Score</div></div>
            </div>
            <div class="deeds-section"><h4 style="font-weight:bold; margin-bottom:8px;">‚≠ê Good Deeds</h4>${good.map(d=>`<div>‚úì ${d}</div>`).join('')}</div>
            <div class="deeds-section"><h4 style="font-weight:bold; margin-bottom:8px;">‚ö†Ô∏è Areas to Improve</h4>${bad.map(d=>`<div>‚Ä¢ ${d}</div>`).join('')}</div>
            <p style="text-align:center; font-size:12px; color:#6b7280; margin-top:16px; font-style:italic;">Report generated by Santa's Elf Monitoring System‚Ñ¢</p>
          </div>
        </div>`;
    }

    // Santa Cam
    const camScenes={
      workshop:{ title:"Santa's Workshop", videos:['workshop1.mp4','workshop2.mp4','workshop3.mp4','workshop4.mp4'] },
      office:{ title:"Santa's Office", videos:['office1.mp4','office2.mp4','office3.mp4','office4.mp4'] },
      stable:{ title:'Reindeer Stable', videos:['stable1.mp4','stable2.mp4','stable3.mp4','stable4.mp4'] },
      kitchen:{ title:"Mrs. Claus' Kitchen", videos:['kitchen1.mp4','kitchen2.mp4','kitchen3.mp4','kitchen4.mp4'] },
      mailroom:{ title:'Mail Room', videos:['mailroom1.mp4','mailroom2.mp4','mailroom3.mp4','mailroom4.mp4'] },
      lab:{ title:'Toy Testing Lab', videos:['lab1.mp4','lab2.mp4','lab3.mp4','lab4.mp4'] }
    };
    function openCam(key){
      const modal=document.getElementById('videoModal'); const video=document.getElementById('modalVideo'); const title=document.getElementById('modalTitle'); const muteBtn=document.getElementById('muteBtn');
      const scene=camScenes[key]; const randomVideo=scene.videos[Math.floor(Math.random()*scene.videos.length)];
      video.src=randomVideo; title.textContent=scene.title; video.muted=false; muteBtn.textContent='üîä Mute'; modal.classList.add('open');
      video.play().catch(()=>{ video.muted=true; muteBtn.textContent='üîá Unmute'; video.play(); });
    }
    function toggleMute(){ const v=document.getElementById('modalVideo'); const b=document.getElementById('muteBtn'); v.muted=!v.muted; b.textContent=v.muted?'üîá Unmute':'üîä Mute'; }
    function restartVideo(){ const v=document.getElementById('modalVideo'); v.currentTime=0; v.play(); }
    function closeModal(){ const m=document.getElementById('videoModal'); const v=document.getElementById('modalVideo'); v.pause(); m.classList.remove('open'); }
    document.getElementById('videoModal').addEventListener('click',e=>{ if(e.target.id==='videoModal') closeModal(); });

    // ===== Letters to Santa logic =====
    const fromEl = document.getElementById('letterFrom');
    const wishEl = document.getElementById('wishlist');
    const bodyEl = document.getElementById('letterBody');
    const charCount = document.getElementById('charCount');
    const previewFrom = document.getElementById('previewFrom');
    const previewWishlist = document.getElementById('previewWishlist');
    const previewBox = document.getElementById('letterPreview');
    const listBox = document.getElementById('lettersList');

    // Prefill FROM with childName initially
    const initialName = document.getElementById('childName').value.trim();
    if(initialName){ fromEl.value = initialName; }
    fromEl.addEventListener('input', ()=>{ fromEl.dataset.touched = '1'; updateLetterPreview(); });

    function updateLetterPreview(){
      const from = (fromEl.value || document.getElementById('childName').value || '').trim();
      const wishlist = (wishEl.value||'').trim();
      const body = (bodyEl.value||'').trim();
      charCount.textContent = body.length;
      previewFrom.textContent = from || '‚Äî';
      previewWishlist.textContent = wishlist || '‚Äî';
      previewBox.querySelector('p').textContent = body ? body : 'Write your letter on the left to see a preview here.';
    }
    wishEl.addEventListener('input', updateLetterPreview);
    bodyEl.addEventListener('input', updateLetterPreview);

    const STORAGE_KEY = 'santaLetters';
    function getStoredLetters(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch{ return []; } }
    function setStoredLetters(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

    function saveLetter(){
      const entry = buildLetterObject();
      const letters = getStoredLetters(); letters.unshift(entry); setStoredLetters(letters);
      renderLetters();
      alert('Saved! This letter is stored only on this device.');
    }

    function buildLetterObject(){
      const from = (fromEl.value || document.getElementById('childName').value || '').trim();
      const wishlist = (wishEl.value||'').trim();
      const body = (bodyEl.value||'').trim();
      const now = new Date();
      return { id: `${now.getTime()}`, from, wishlist, body, createdAt: now.toISOString() };
    }

    function downloadLetter(){
      const entry = buildLetterObject();
      const content = `Dear Santa,\n\n${entry.body}\n\nFrom,\n${entry.from || '‚Äî'}\n\nWishlist: ${entry.wishlist || '‚Äî'}\nDate: ${new Date(entry.createdAt).toLocaleString()}`;
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `letter-to-santa_${new Date().toISOString().slice(0,10)}.txt`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function printLetter(){
      const entry = buildLetterObject();
      const w = window.open('', '_blank');
      w.document.write(`<!DOCTYPE html><html><head><title>Letter to Santa</title><style>body{font-family:Georgia,serif; padding:40px; background:#faf7e8; color:#2b2b2b;} h1{color:#7c2d12} .meta{margin-top:20px; font-size:14px; color:#555}</style></head><body><h1>Dear Santa,</h1><p style="white-space:pre-wrap; line-height:1.8">${(entry.body||'').replace(/</g,'&lt;')}</p><div class="meta"><b>From:</b> ${entry.from||'‚Äî'}<br><b>Wishlist:</b> ${entry.wishlist||'‚Äî'}<br><b>Date:</b> ${new Date(entry.createdAt).toLocaleString()}</div></body></html>`);
      w.document.close(); w.focus(); w.print();
    }

    async function shareLetter(){
      const entry = buildLetterObject();
      const text = `Dear Santa,\n\n${entry.body}\n\nFrom, ${entry.from || '‚Äî'}\nWishlist: ${entry.wishlist || '‚Äî'}`;
      if(navigator.share){
        try{ await navigator.share({ title: 'Letter to Santa', text }); } catch(e){ /* user canceled */ }
      } else {
        // Fallback: mailto draft
        const subject = encodeURIComponent('Letter to Santa');
        const body = encodeURIComponent(text);
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
      }
    }

    function renderLetters(){
      const letters = getStoredLetters();
      listBox.innerHTML = letters.map(l=>{
        const date = new Date(l.createdAt).toLocaleString();
        return `<div class="letter-item"><div><b>${l.from||'‚Äî'}</b><div class="hint">${date}</div></div><div class="pill-row"><span class="pill">Saved</span><button class="btn ghost" onclick="restoreLetter('${l.id}')">Open</button><button class="btn ghost" onclick="deleteLetter('${l.id}')">Delete</button></div></div>`;
      }).join('');
    }

    function restoreLetter(id){
      const l = getStoredLetters().find(x=>x.id===id); if(!l) return;
      fromEl.value = l.from||''; wishEl.value = l.wishlist||''; bodyEl.value = l.body||''; updateLetterPreview();
      // Switch to Letter tab if not already
      const letterTabBtn = Array.from(document.querySelectorAll('.tab')).find(b=>b.textContent.includes('Letter'));
      if(letterTabBtn){ switchTab({target:letterTabBtn}, 'letter'); }
    }

    function deleteLetter(id){
      const rest = getStoredLetters().filter(x=>x.id!==id); setStoredLetters(rest); renderLetters();
    }

    // Initial render
    updateButtonText();
    updateLetterPreview();
    renderLetters();
  </script>
</body>
</html>
