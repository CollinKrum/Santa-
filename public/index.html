<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Ads (unchanged) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7145940911173373" crossorigin="anonymous"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Santa's Command Center</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(to bottom right, #450a0a, #7f1d1d, #14532d);
      min-height: 100vh;
      color: white;
      padding: 20px;
    }
    @keyframes wiggle { 0%,100%{transform:rotate(0)} 25%{transform:rotate(-5deg)} 75%{transform:rotate(5deg)} }
    @keyframes float {
      0% { transform: translateY(-100px) translateX(0); opacity: 0; }
      50% { transform: translateY(50vh) translateX(30px); opacity: 0.2; }
      100% { transform: translateY(110vh) translateX(0); opacity: 0; }
    }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.7} }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    .snowflake { position: fixed; top: -50px; color: white; font-size: 20px; opacity: 0.2; pointer-events: none; animation: float linear infinite; z-index: 1; }
    .container { max-width: 800px; margin: 0 auto; position: relative; z-index: 10; }
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { font-size: clamp(32px, 5vw, 48px); font-weight: bold; margin-bottom: 8px; }
    .santa-icon { display: inline-block; font-size: 64px; animation: wiggle 2s ease-in-out infinite; }
    .subtitle { color: #fecaca; font-size: 18px; }
    .card { background: rgba(255,255,255,.1); backdrop-filter: blur(10px); border-radius: 24px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,.5); }
    .name-input-section { background: linear-gradient(to right, #dc2626, #ef4444, #16a34a); padding: 24px; }
    .name-input-section label { display:block; color:white; font-size:12px; font-weight:bold; letter-spacing:1px; margin-bottom:12px; }
    .name-input-section input { width:100%; padding:16px 20px; border-radius:16px; border:none; font-size:18px; outline:none; }

    .tabs { display:flex; background: rgba(255,255,255,.05); border-bottom:1px solid rgba(255,255,255,.1); }
    .tab { flex:1; padding:20px; text-align:center; cursor:pointer; background:transparent; border:none; color:rgba(255,255,255,.6); font-size:14px; font-weight:600; transition:.3s; position:relative; }
    .tab:hover { color:rgba(255,255,255,.9); }
    .tab.active { color:white; background: rgba(255,255,255,.1); }
    .tab.active::after { content:''; position:absolute; bottom:0; left:0; right:0; height:3px; background: linear-gradient(to right, #dc2626, #16a34a); border-radius:3px 3px 0 0; }
    .tab-icon { display:block; font-size:24px; margin-bottom:4px; }

    .tab-content { padding:24px; min-height:500px; }
    .tab-pane { display:none; }
    .tab-pane.active { display:block; }

    .message-buttons { display:flex; flex-direction:column; gap:12px; }
    .message-btn { display:flex; justify-content:space-between; align-items:center; padding:20px; border-radius:16px; border:none; font-size:16px; font-weight:600; color:white; cursor:pointer; transition: transform .2s; position:relative; }
    .message-btn:hover:not(:disabled){ transform: scale(1.05); }
    .message-btn:active:not(:disabled){ transform: scale(0.95); }
    .message-btn:disabled{ opacity:.6; cursor:not-allowed; transform:none !important; }
    .message-btn.nice{ background: linear-gradient(135deg, #10b981, #059669); }
    .message-btn.naughty{ background: linear-gradient(135deg, #ef4444, #dc2626); }
    .message-btn.neutral{ background: linear-gradient(135deg, #3b82f6, #2563eb); }

    .speaking-indicator { margin-top:16px; padding:16px; background: linear-gradient(135deg, #dc2626, #16a34a); border-radius:16px; text-align:center; font-weight:bold; animation: pulse 1.5s ease-in-out infinite; }

    .generate-btn { width:100%; padding:24px; border-radius:16px; border:none; background: linear-gradient(135deg, #dc2626, #ef4444, #16a34a); color:white; font-size:18px; font-weight:bold; cursor:pointer; margin-bottom:24px; transition: transform .2s; }
    .generate-btn:hover{ transform: scale(1.05); }

    .report-card{ background:white; color:#1f2937; border-radius:20px; overflow:hidden; }
    .report-header{ background: linear-gradient(135deg, #dc2626, #16a34a); color:white; padding:24px; text-align:center; }
    .report-content{ padding:24px; }
    .report-scores{ display:grid; grid-template-columns:1fr 1fr; gap:16px; margin:20px 0; }
    .score-box{ padding:20px; border-radius:16px; text-align:center; }
    .score-box.nice{ background:#d1fae5; }
    .score-box.naughty{ background:#fee2e2; }
    .score-number{ font-size:48px; font-weight:bold; }

    .deeds-section{ background:#f3f4f6; padding:16px; border-radius:12px; margin:16px 0; }

    .cam-grid{ display:grid; grid-template-columns: repeat(2,1fr); gap:12px; }
    @media (min-width:640px){ .cam-grid{ grid-template-columns: repeat(3,1fr); } }
    .cam-button{ padding:20px; border-radius:16px; border:none; color:white; font-weight:bold; cursor:pointer; transition: transform .2s; text-align:center; }
    .cam-button:hover{ transform: scale(1.05); }
    .cam-emoji{ font-size:40px; display:block; margin-bottom:8px; }
    .cam-title{ font-size:14px; display:block; }

    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.9); z-index:1000; padding:20px; }
    .modal.open{ display:flex; align-items:center; justify-content:center; }
    .modal-content{ width:100%; max-width:1000px; background:#000; border-radius:16px; overflow:hidden; }
    .modal-header{ display:flex; justify-content:space-between; align-items:center; padding:16px; background:#1f1f1f; }
    .close-btn{ background:#dc2626; color:white; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; font-weight:bold; }

    .video-container{ background:#000; display:flex; align-items:center; justify-content:center; min-height:400px; }
    .video-container video{ width:100%; max-height:80vh; object-fit:contain; display:block; }

    .video-controls{ padding:16px; background:#1f1f1f; display:flex; gap:12px; justify-content:center; }
    .control-btn{ background:#374151; color:white; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; font-weight:600; font-size:14px; }
    .control-btn:hover{ background:#4b5563; }

    .footer{ text-align:center; margin-top:40px; opacity:.6; font-size:14px; }
    
    .countdown-banner { 
      background: linear-gradient(135deg, #dc2626, #991b1b); 
      padding: 20px; 
      text-align: center; 
      border-radius: 20px; 
      margin-bottom: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,.3);
      position: relative;
      overflow: hidden;
    }
    .countdown-banner::before {
      content: '‚ùÑÔ∏è';
      position: absolute;
      font-size: 100px;
      opacity: 0.1;
      left: -20px;
      top: -20px;
      animation: wiggle 3s ease-in-out infinite;
    }
    .countdown-banner::after {
      content: 'üéÑ';
      position: absolute;
      font-size: 100px;
      opacity: 0.1;
      right: -20px;
      bottom: -20px;
      animation: wiggle 3s ease-in-out infinite reverse;
    }
    .countdown-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #fecaca;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .countdown-display {
      display: flex;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .countdown-box {
      background: rgba(255,255,255,.2);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 16px 20px;
      min-width: 80px;
      border: 2px solid rgba(255,255,255,.3);
    }
    .countdown-number {
      font-size: 36px;
      font-weight: bold;
      color: white;
      display: block;
      line-height: 1;
    }
    .countdown-label {
      font-size: 12px;
      color: #fecaca;
      margin-top: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px rgba(220, 38, 38, 0.5); }
      50% { box-shadow: 0 0 40px rgba(220, 38, 38, 0.8); }
    }
    .countdown-banner.christmas-day {
      background: linear-gradient(135deg, #16a34a, #059669);
      animation: glow 2s ease-in-out infinite;
    }
    
    .advent-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 12px;
      padding: 20px;
      background: white;
      border-radius: 20px;
    }
    .advent-day {
      aspect-ratio: 1;
      background: linear-gradient(135deg, #dc2626, #991b1b);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      border: 3px solid #7f1d1d;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .advent-day:hover:not(.locked):not(.opened) {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
    }
    .advent-day.locked {
      background: linear-gradient(135deg, #6b7280, #4b5563);
      cursor: not-allowed;
      opacity: 0.6;
    }
    .advent-day.opened {
      background: linear-gradient(135deg, #16a34a, #059669);
      border-color: #14532d;
    }
    .advent-day.today {
      animation: glow 2s ease-in-out infinite;
      border-color: #fbbf24;
    }
    .advent-number {
      font-size: 28px;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .advent-icon {
      font-size: 20px;
      margin-top: 4px;
    }
    .advent-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .advent-modal.open {
      display: flex;
    }
    .advent-modal-content {
      background: white;
      border-radius: 24px;
      padding: 32px;
      max-width: 500px;
      width: 100%;
      text-align: center;
      position: relative;
      color: #1f2937;
    }
    .advent-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: #dc2626;
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
    }
    .advent-surprise {
      font-size: 64px;
      margin: 20px 0;
      animation: bounce 1s ease-out;
    }
    
    .chat-container {
      background: white;
      border-radius: 20px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 600px;
    }
    .chat-header {
      background: linear-gradient(135deg, #dc2626, #16a34a);
      color: white;
      padding: 20px;
      text-align: center;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f9fafb;
    }
    .chat-message {
      margin-bottom: 16px;
      display: flex;
      gap: 12px;
    }
    .chat-message.santa {
      flex-direction: row;
    }
    .chat-message.user {
      flex-direction: row-reverse;
    }
    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
    }
    .chat-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 16px;
      color: #1f2937;
      line-height: 1.5;
    }
    .chat-message.santa .chat-bubble {
      background: white;
      border: 2px solid #fee2e2;
      border-radius: 16px 16px 16px 4px;
    }
    .chat-message.user .chat-bubble {
      background: #dbeafe;
      border-radius: 16px 16px 4px 16px;
    }
    .chat-input-area {
      padding: 16px;
      background: white;
      border-top: 2px solid #e5e7eb;
      display: flex;
      gap: 12px;
    }
    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 24px;
      font-size: 16px;
      outline: none;
      font-family: inherit;
    }
    .chat-input:focus {
      border-color: #dc2626;
    }
    .chat-send-btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #dc2626, #16a34a);
      color: white;
      border: none;
      border-radius: 24px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .chat-send-btn:hover:not(:disabled) {
      transform: scale(1.05);
    }
    .chat-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .chat-typing {
      display: flex;
      gap: 4px;
      padding: 12px 16px;
    }
    .chat-typing-dot {
      width: 8px;
      height: 8px;
      background: #9ca3af;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }
    .chat-typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }
    .chat-typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }
  </style>
</head>
<body>
  <div id="snowflakes"></div>

  <div class="container">
    <div class="header">
      <div style="position: relative; display: inline-block;">
        <span class="santa-icon">üéÖ</span>
        <span style="position: absolute; top: -10px; right: -10px; font-size: 32px;">‚ú®</span>
      </div>
      <h1>Santa's Command Center</h1>
      <p class="subtitle">Live from the North Pole ‚Ä¢ Powered by ElevenLabs AI</p>
    </div>

    <!-- Countdown to Christmas -->
    <div id="countdownBanner" class="countdown-banner">
      <div class="countdown-title">üéÖ Countdown to Christmas üéÑ</div>
      <div class="countdown-display">
        <div class="countdown-box">
          <span class="countdown-number" id="days">0</span>
          <span class="countdown-label">Days</span>
        </div>
        <div class="countdown-box">
          <span class="countdown-number" id="hours">0</span>
          <span class="countdown-label">Hours</span>
        </div>
        <div class="countdown-box">
          <span class="countdown-number" id="minutes">0</span>
          <span class="countdown-label">Minutes</span>
        </div>
        <div class="countdown-box">
          <span class="countdown-number" id="seconds">0</span>
          <span class="countdown-label">Seconds</span>
        </div>
      </div>
    </div>

    <div class="card">
      <!-- Name Input -->
      <div class="name-input-section">
        <label>CHILD'S NAME</label>
        <input type="text" id="childName" placeholder="Enter name here..." />
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab(this,'soundboard')">
          <span class="tab-icon">üîä</span>
          <span>Soundboard</span>
        </button>
        <button class="tab" onclick="switchTab(this,'chat')">
          <span class="tab-icon">üí¨</span>
          <span>Chat with Santa</span>
        </button>
        <button class="tab" onclick="switchTab(this,'report')">
          <span class="tab-icon">üìÑ</span>
          <span>Report Card</span>
        </button>
        <button class="tab" onclick="switchTab(this,'letter')">
          <span class="tab-icon">‚úâÔ∏è</span>
          <span>Letter to Santa</span>
        </button>
        <button class="tab" onclick="switchTab(this,'advent')">
          <span class="tab-icon">üéÅ</span>
          <span>Advent Calendar</span>
        </button>
        <button class="tab" onclick="switchTab(this,'elf')">
          <span class="tab-icon">üßù</span>
          <span>Elf Name</span>
        </button>
        <button class="tab" onclick="switchTab(this,'cam')">
          <span class="tab-icon">üìπ</span>
          <span>Santa Cam</span>
        </button>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Soundboard -->
        <div id="soundboard" class="tab-pane active">
          <div class="message-buttons" id="messageButtons"></div>
          <div id="speakingIndicator" style="display: none;" class="speaking-indicator">üîä Santa is speaking...</div>
        </div>

        <!-- Chat with Santa -->
        <div id="chat" class="tab-pane">
          <div class="chat-container">
            <div class="chat-header">
              <div style="font-size: 48px; margin-bottom: 8px;">üéÖ</div>
              <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 4px;">Chat with Santa Claus</h2>
              <p style="font-size: 14px; opacity: 0.9;">Ask Santa anything! He's listening from the North Pole</p>
            </div>
            <div class="chat-messages" id="chatMessages">
              <div class="chat-message santa">
                <div class="chat-avatar">üéÖ</div>
                <div class="chat-bubble">
                  Ho ho ho! Welcome to the North Pole! I'm Santa Claus, and I'm so happy to chat with you! What's your name, my dear friend?
                </div>
              </div>
            </div>
            <div class="chat-input-area">
              <input 
                type="text" 
                id="chatInput" 
                class="chat-input" 
                placeholder="Type your message to Santa..."
                onkeypress="if(event.key==='Enter') sendChatMessage()"
              />
              <button class="chat-send-btn" onclick="sendChatMessage()" id="chatSendBtn">Send üéÅ</button>
            </div>
          </div>
        </div>

        <!-- Report Card -->
        <div id="report" class="tab-pane">
          <button class="generate-btn" onclick="generateReport()">‚ú® Generate Report Card</button>
          <div id="reportResult"></div>
        </div>

        <!-- Letter to Santa -->
        <div id="letter" class="tab-pane">
          <div style="background: white; color: #1f2937; border-radius: 20px; padding: 24px; margin-bottom: 20px;">
            <div style="text-align: center; margin-bottom: 20px;">
              <div style="font-size: 48px; margin-bottom: 8px;">üéÖüìÆ</div>
              <h2 style="font-size: 24px; font-weight: bold; color: #dc2626;">Write a Letter to Santa</h2>
              <p style="font-size: 14px; color: #6b7280; margin-top: 8px;">Tell Santa what you'd like for Christmas!</p>
            </div>
            
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Your Name:</label>
              <input type="text" id="letterName" placeholder="Enter your name..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; outline: none; transition: 0.2s;" onfocus="this.style.borderColor='#dc2626'" onblur="this.style.borderColor='#e5e7eb'" />
            </div>
            
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Your Letter:</label>
              <textarea id="letterContent" placeholder="Dear Santa,&#10;&#10;This year I have been very good! For Christmas, I would like...&#10;&#10;Thank you!" style="width: 100%; min-height: 250px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; font-family: 'Comic Sans MS', cursive; outline: none; resize: vertical; transition: 0.2s;" onfocus="this.style.borderColor='#dc2626'" onblur="this.style.borderColor='#e5e7eb'"></textarea>
            </div>
            
            <div style="display: flex; gap: 12px;">
              <button onclick="saveLetterLocally()" style="flex: 1; padding: 16px; border: none; border-radius: 12px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                üíæ Save Locally
              </button>
              <button onclick="sendLetterToSanta()" style="flex: 1; padding: 16px; border: none; border-radius: 12px; background: linear-gradient(135deg, #dc2626, #16a34a); color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                üìÆ Send to Santa
              </button>
            </div>
          </div>
          
          <div id="letterStatus" style="display: none;"></div>
        </div>

        <!-- Elf Name Generator -->
        <div id="elf" class="tab-pane">
          <div style="background: white; color: #1f2937; border-radius: 20px; padding: 24px;">
            <div style="text-align: center; margin-bottom: 24px;">
              <div style="font-size: 64px; margin-bottom: 12px;">üßù‚Äç‚ôÇÔ∏è‚ú®üßù‚Äç‚ôÄÔ∏è</div>
              <h2 style="font-size: 28px; font-weight: bold; color: #16a34a;">Elf Name Generator</h2>
              <p style="font-size: 14px; color: #6b7280; margin-top: 8px;">Discover your official North Pole elf name!</p>
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Enter Your Name:</label>
              <input type="text" id="elfNameInput" placeholder="Your name..." style="width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 18px; outline: none; transition: 0.2s;" onfocus="this.style.borderColor='#16a34a'" onblur="this.style.borderColor='#e5e7eb'" />
            </div>
            
            <button onclick="generateElfName()" style="width: 100%; padding: 18px; border: none; border-radius: 12px; background: linear-gradient(135deg, #16a34a, #059669); color: white; font-size: 18px; font-weight: bold; cursor: pointer; transition: transform 0.2s; margin-bottom: 24px;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
              ‚ú® Generate My Elf Name
            </button>
            
            <div id="elfNameResult" style="display: none;"></div>
          </div>
        </div>

        <!-- Advent Calendar -->
        <div id="advent" class="tab-pane">
          <div style="text-align: center; margin-bottom: 20px;">
            <h2 style="font-size: 28px; font-weight: bold; margin-bottom: 8px;">üéÑ Advent Calendar üéÅ</h2>
            <p style="font-size: 14px; opacity: 0.8;">Open a new surprise each day leading up to Christmas!</p>
          </div>
          <div class="advent-grid" id="adventGrid"></div>
        </div>

        <!-- Santa Cam -->
        <div id="cam" class="tab-pane">
          <div class="cam-grid">
            <button class="cam-button" style="background: linear-gradient(135deg, #d97706, #ea580c);" onclick="openCam('workshop')">
              <span class="cam-emoji">üéÅ</span><span class="cam-title">Workshop</span>
            </button>
            <button class="cam-button" style="background: linear-gradient(135deg, #dc2626, #991b1b);" onclick="openCam('office')">
              <span class="cam-emoji">üìã</span><span class="cam-title">Office</span>
            </button>
            <button class="cam-button" style="background: linear-gradient(135deg, #475569, #334155);" onclick="openCam('stable')">
              <span class="cam-emoji">ü¶å</span><span class="cam-title">Stable</span>
            </button>
            <button class="cam-button" style="background: linear-gradient(135deg, #ec4899, #be185d);" onclick="openCam('kitchen')">
              <span class="cam-emoji">üç™</span><span class="cam-title">Kitchen</span>
            </button>
            <button class="cam-button" style="background: linear-gradient(135deg, #2563eb, #1e40af);" onclick="openCam('mailroom')">
              <span class="cam-emoji">‚úâÔ∏è</span><span class="cam-title">Mail Room</span>
            </button>
            <button class="cam-button" style="background: linear-gradient(135deg, #059669, #047857);" onclick="openCam('lab')">
              <span class="cam-emoji">üß∏</span><span class="cam-title">Toy Lab</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      Made with holiday magic & Christmas spirit<br />
      ¬© 2024 North Pole Technologies
    </div>
  </div>

  <!-- Advent Calendar Modal -->
  <div id="adventModal" class="advent-modal">
    <div class="advent-modal-content">
      <button class="advent-close" onclick="closeAdventModal()">√ó</button>
      <div id="adventSurpriseContent"></div>
    </div>
  </div>

  <!-- Video Modal -->
  <div id="videoModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span id="modalTitle">Santa Cam</span>
        <button class="close-btn" onclick="closeModal()">Close</button>
      </div>
      <div class="video-container">
        <video id="modalVideo" autoplay loop playsinline></video>
      </div>
      <div class="video-controls">
        <button class="control-btn" id="muteBtn" onclick="toggleMute()">üîä Mute</button>
        <button class="control-btn" onclick="restartVideo()">‚Üª Restart</button>
      </div>
    </div>
  </div>

  <script>
    /**************  COUNTDOWN TO CHRISTMAS  **************/
    function updateCountdown() {
      const now = new Date();
      const currentYear = now.getFullYear();
      
      // Set Christmas date (December 25 at midnight)
      let christmas = new Date(currentYear, 11, 25, 0, 0, 0);
      
      // If Christmas has passed this year, set to next year
      if (now > christmas) {
        christmas = new Date(currentYear + 1, 11, 25, 0, 0, 0);
      }
      
      const diff = christmas - now;
      
      // Calculate time units
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);
      
      // Update display
      document.getElementById('days').textContent = days;
      document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
      document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
      document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
      
      // Special handling for Christmas Day
      const banner = document.getElementById('countdownBanner');
      if (days === 0 && hours === 0) {
        banner.classList.add('christmas-day');
        document.querySelector('.countdown-title').textContent = 'üéÖ MERRY CHRISTMAS! üéÑ';
      } else {
        banner.classList.remove('christmas-day');
      }
    }
    
    // Update countdown immediately and every second
    updateCountdown();
    setInterval(updateCountdown, 1000);

    /**************  UTIL & DECORATION  **************/
    // Snowflakes
    const snowflakesContainer = document.getElementById('snowflakes');
    (function makeSnowflakes(){
      for (let i = 0; i < 20; i++) {
        const s = document.createElement('div');
        s.className = 'snowflake';
        s.textContent = '‚ùÑ';
        s.style.left = Math.random() * 100 + '%';
        s.style.animationDelay = Math.random() * 5 + 's';
        s.style.animationDuration = Math.random() * 10 + 15 + 's';
        snowflakesContainer.appendChild(s);
      }
    })();

    // Tabs
    function switchTab(btnEl, tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
      btnEl.classList.add('active');
      document.getElementById(tabName).classList.add('active');
    }

    /**************  SOUNDBOARD + ELEVENLABS TTS  **************/
    let currentAudio = null;

    const messages = [
      { text: "Ho ho ho! You've been very good today, {name}!", type: "nice", emoji: "üéÖ" },
      { text: "{name}, you're on the nice list this year!", type: "nice", emoji: "‚≠ê" },
      { text: "Wonderful job, {name}! Keep up the good work!", type: "nice", emoji: "üåü" },
      { text: "Santa sees you being kind, {name}!", type: "nice", emoji: "üíö" },
      { text: "{name}, I'm watching you... heading towards the naughty list!", type: "naughty", emoji: "üëÄ" },
      { text: "Ho ho... oh no, {name}! Better watch out!", type: "naughty", emoji: "‚ö†Ô∏è" },
      { text: "{name}, that behavior might get you coal for Christmas!", type: "naughty", emoji: "ü™®" },
      { text: "Careful, {name}! You're skating on thin ice!", type: "naughty", emoji: "‚ùÑÔ∏è" },
      { text: "Merry Christmas, {name}! Have a magical holiday!", type: "nice", emoji: "üéÑ" },
      { text: "{name}, have you been naughty or nice this year?", type: "neutral", emoji: "üéÖ" },
    ];

    const messageButtonsContainer = document.getElementById('messageButtons');

    function updateButtonText() {
      const name = (document.getElementById('childName').value || '').trim() || 'little one';
      const buttons = document.querySelectorAll('.message-btn');
      buttons.forEach((btn, idx) => {
        const msg = messages[idx];
        const span = btn.querySelector('.btn-text');
        if (span) span.innerHTML = msg.text.replace(/{name}/g, `<strong>${name}</strong>`);
      });
    }

    // Build buttons
    messages.forEach((msg) => {
      const btn = document.createElement('button');
      btn.className = `message-btn ${msg.type}`;
      btn.innerHTML = `
        <span class="btn-text">${msg.text.replace(/{name}/g, '<strong>little one</strong>')}</span>
        <span style="font-size: 30px;">${msg.emoji}</span>
      `;
      btn.onclick = () => speakMessage(msg.text);
      messageButtonsContainer.appendChild(btn);
    });

    document.getElementById('childName').addEventListener('input', updateButtonText);

    // Auto-fill name across all sections
    document.getElementById('childName').addEventListener('input', function() {
      const name = this.value;
      updateButtonText(); // Update soundboard buttons
      
      // Update letter name if empty
      const letterNameInput = document.getElementById('letterName');
      if (letterNameInput) {
        letterNameInput.value = name;
      }
      
      // Update elf name input if empty
      const elfNameInput = document.getElementById('elfNameInput');
      if (elfNameInput) {
        elfNameInput.value = name;
      }
    });

    // ElevenLabs via serverless endpoint: /api/santa-voice
    async function speakMessage(text) {
      const name = (document.getElementById('childName').value || '').trim() || 'little one';
      const personalized = text.replace(/{name}/g, name);

      if (currentAudio) { currentAudio.pause(); currentAudio = null; }

      const buttons = document.querySelectorAll('.message-btn');
      buttons.forEach(b => b.disabled = true);
      const indicator = document.getElementById('speakingIndicator');
      indicator.style.display = 'block';

      try {
        const response = await fetch('/api/santa-voice', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: personalized })
        });

        if (!response.ok) {
          const detail = await response.text().catch(()=>'');
          throw new Error(`API Error: ${response.status} ${response.statusText}\n${detail}`);
        }

        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);

        currentAudio = new Audio(audioUrl);
        currentAudio.onended = () => {
          indicator.style.display = 'none';
          buttons.forEach(b => b.disabled = false);
          currentAudio = null;
        };
        currentAudio.onerror = () => {
          indicator.style.display = 'none';
          buttons.forEach(b => b.disabled = false);
          alert('Error playing audio.');
        };

        await currentAudio.play();
      } catch (err) {
        console.error('Error generating Santa voice:', err);
        indicator.style.display = 'none';
        buttons.forEach(b => b.disabled = false);
        alert('Error generating Santa voice. Please try again.\n\n' + (err?.message || err));
      }
    }

    /**************  REPORT CARD  **************/
    function generateReport() {
      const name = (document.getElementById('childName').value || '').trim() || 'this child';
      const niceScore = Math.floor(Math.random() * 40) + 60;
      const naughtyScore = 100 - niceScore;
      const status = niceScore >= 75 ? 'NICE LIST' : niceScore >= 60 ? 'WATCH LIST' : 'NAUGHTY LIST';
      const statusEmoji = niceScore >= 75 ? '‚≠ê' : niceScore >= 60 ? '‚ö†Ô∏è' : 'üéÖ';

      const allGoodDeeds = [
        'Shared toys with siblings','Helped with chores without being asked','Was kind to classmates',
        'Did homework on time','Cleaned their room','Said please and thank you','Helped a friend in need',
        'Was respectful to adults','Took care of a pet','Made their bed every morning','Ate vegetables without complaining',
        'Brushed teeth without reminders','Helped carry groceries','Shared snacks with others','Was patient while waiting',
        'Used kind words','Helped set the dinner table','Picked up after themselves','Was a good sport in games','Showed empathy to others'
      ];
      const allNaughtyDeeds = [
        'Argued with siblings',"Didn't listen the first time",'Left toys scattered around','Complained about bedtime',
        'Forgot to do assigned chores','Talked back occasionally','Needed reminders to clean up','Interrupted adults talking',
        'Was grumpy in the morning','Fought over screen time',"Didn't finish dinner",'Procrastinated on homework',
        'Made excuses for mistakes','Whined about going outside','Refused to share sometimes','Was too rough with pets',
        'Stayed up past bedtime','Complained about chores','Left wet towels on the floor','Needed multiple reminders'
      ];

      const goodDeeds = [...allGoodDeeds].sort(()=>0.5-Math.random()).slice(0,4);
      const naughtyDeeds = [...allNaughtyDeeds].sort(()=>0.5-Math.random()).slice(0, Math.floor(Math.random()*2)+2);

      document.getElementById('reportResult').innerHTML = `
        <div class="report-card">
          <div class="report-header">
            <div style="font-size:40px; margin-bottom:8px;">üéÑ</div>
            <h2 style="font-size:24px; font-weight:bold;">OFFICIAL SANTA REPORT</h2>
            <p style="font-size:14px; margin-top:4px;">North Pole ‚Ä¢ ${new Date().toLocaleDateString()}</p>
          </div>
          <div class="report-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
              <h3 style="font-size:24px; font-weight:bold;">${name}</h3>
              <span style="background:${status.includes('NICE') ? '#10b981' : status.includes('WATCH') ? '#fbbf24' : '#ef4444'}; color:white; padding:8px 16px; border-radius:20px; font-weight:bold; font-size:12px;">
                ${statusEmoji} ${status}
              </span>
            </div>
            <div class="report-scores">
              <div class="score-box nice">
                <div class="score-number" style="color:#059669;">${niceScore}%</div>
                <div style="font-size:14px; font-weight:600; color:#059669;">Nice Score</div>
              </div>
              <div class="score-box naughty">
                <div class="score-number" style="color:#dc2626;">${naughtyScore}%</div>
                <div style="font-size:14px; font-weight:600; color:#dc2626;">Naughty Score</div>
              </div>
            </div>
            <div class="deeds-section">
              <h4 style="font-weight:bold; margin-bottom:8px;">‚≠ê Good Deeds</h4>
              ${goodDeeds.map(d => `<div>‚úì ${d}</div>`).join('')}
            </div>
            <div class="deeds-section">
              <h4 style="font-weight:bold; margin-bottom:8px;">‚ö†Ô∏è Areas to Improve</h4>
              ${naughtyDeeds.map(d => `<div>‚Ä¢ ${d}</div>`).join('')}
            </div>
            <p style="text-align:center; font-size:12px; color:#6b7280; margin-top:16px; font-style:italic;">
              Report generated by Santa's Elf Monitoring System‚Ñ¢
            </p>
          </div>
        </div>
      `;
    }

    /**************  LETTER TO SANTA  **************/
    function saveLetterLocally() {
      let name = document.getElementById('letterName').value.trim();
      const content = document.getElementById('letterContent').value.trim();
      
      // Use main name if letter name is empty
      if (!name) {
        name = document.getElementById('childName').value.trim();
      }
      
      if (!name || !content) {
        alert('Please fill in both your name and letter content!');
        return;
      }
      
      const letterText = `Letter to Santa from ${name}\n${new Date().toLocaleDateString()}\n\n${content}`;
      const blob = new Blob([letterText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Letter_to_Santa_${name.replace(/\s+/g, '_')}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showLetterStatus('üíæ Letter saved to your device!', '#3b82f6');
    }
    
    function sendLetterToSanta() {
      let name = document.getElementById('letterName').value.trim();
      const content = document.getElementById('letterContent').value.trim();
      
      // Use main name if letter name is empty
      if (!name) {
        name = document.getElementById('childName').value.trim();
      }
      
      if (!name || !content) {
        alert('Please fill in both your name and letter content!');
        return;
      }
      
      showLetterStatus('üìÆ Sending to the North Pole...', '#fbbf24');
      
      setTimeout(() => {
        showLetterStatus(`
          <div style="text-align: center;">
            <div style="font-size: 64px; margin-bottom: 16px; animation: bounce 1s ease-in-out;">üéÖ‚ú®</div>
            <h3 style="font-size: 24px; font-weight: bold; color: #059669; margin-bottom: 8px;">Letter Delivered!</h3>
            <p style="font-size: 16px; color: #374151;">Santa has received your letter, ${name}!</p>
            <p style="font-size: 14px; color: #6b7280; margin-top: 8px;">He's checking it twice and adding it to his special list. üéÑ</p>
          </div>
        `, 'linear-gradient(135deg, #d1fae5, #a7f3d0)');
        
        setTimeout(() => {
          document.getElementById('letterName').value = '';
          document.getElementById('letterContent').value = '';
        }, 2000);
      }, 2000);
    }
    
    function showLetterStatus(message, bgColor) {
      const statusDiv = document.getElementById('letterStatus');
      statusDiv.innerHTML = `
        <div style="background: ${bgColor}; color: #1f2937; border-radius: 16px; padding: 20px; text-align: center; font-weight: 600;">
          ${message}
        </div>
      `;
      statusDiv.style.display = 'block';
    }

    /**************  ELF NAME GENERATOR  **************/
    function generateElfName() {
      let name = document.getElementById('elfNameInput').value.trim();
      
      // Use main name if elf name input is empty
      if (!name) {
        name = document.getElementById('childName').value.trim();
      }
      
      if (!name) {
        alert('Please enter your name in the name field at the top!');
        return;
      }

      const prefixes = [
        'Sparkle', 'Jingle', 'Twinkle', 'Sugar', 'Jolly', 'Merry', 'Cocoa', 'Candy',
        'Ginger', 'Snowflake', 'Peppermint', 'Holly', 'Frosty', 'Tinsel', 'Glitter',
        'Cinnamon', 'Cookie', 'Mistletoe', 'Starlight', 'Chestnut', 'Nutmeg', 'Angel',
        'Berry', 'Sparkly', 'Cheery', 'Snowy', 'Elfie', 'Pudding', 'Caramel', 'Zippy'
      ];

      const suffixes = [
        'toes', 'bells', 'shine', 'plum', 'whiskers', 'bright', 'flakes', 'paws',
        'nose', 'sparkle', 'jingles', 'cheeks', 'buttons', 'wings', 'giggles',
        'twirl', 'bounce', 'dash', 'frost', 'sweet', 'star', 'berry', 'shoes',
        'hat', 'ears', 'glow', 'hop', 'skip', 'jump', 'smile'
      ];

      const titles = [
        'Chief Toy Inspector', 'Master Gift Wrapper', 'Head Cookie Taster',
        'Lead Reindeer Trainer', 'Senior Sleigh Engineer', 'Top Tinsel Arranger',
        'Premier Present Sorter', 'Chief Snow Sculptor', 'Master List Checker',
        'Head Jingle Composer', 'Lead Stocking Stuffer', 'Senior Candy Cane Maker',
        'Top Ornament Designer', 'Chief Wish Granter', 'Master Elf Motivator',
        'Head Chimney Navigator', 'Lead Magic Distributor', 'Senior Joy Spreader'
      ];

      // Generate consistent name based on input
      const nameHash = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
      const prefix = prefixes[nameHash % prefixes.length];
      const suffix = suffixes[(nameHash * 7) % suffixes.length];
      const title = titles[(nameHash * 13) % titles.length];
      const elfNumber = (nameHash % 999) + 1;

      const elfName = `${prefix}${suffix}`;
      
      const resultDiv = document.getElementById('elfNameResult');
      resultDiv.innerHTML = `
        <div style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); padding: 24px; border-radius: 16px; text-align: center; animation: bounce 0.5s ease-out;">
          <div style="font-size: 48px; margin-bottom: 12px;">üßù‚Äç‚ôÇÔ∏è‚ú®</div>
          <h3 style="font-size: 14px; color: #059669; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Your Official Elf Name</h3>
          <div style="font-size: 32px; font-weight: bold; color: #16a34a; margin-bottom: 8px;">${elfName}</div>
          <div style="background: white; padding: 12px; border-radius: 12px; margin: 16px 0;">
            <p style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">Official Title:</p>
            <p style="font-size: 18px; font-weight: 600; color: #374151;">${title}</p>
          </div>
          <div style="display: inline-block; background: #16a34a; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600;">
            ELF #${String(elfNumber).padStart(3, '0')}
          </div>
          <p style="font-size: 12px; color: #6b7280; margin-top: 16px; font-style: italic;">
            Welcome to Santa's Workshop, ${elfName}! üéÑ
          </p>
        </div>
      `;
      resultDiv.style.display = 'block';
    }

    /**************  ADVENT CALENDAR  **************/
    const adventSurprises = [
      { icon: 'üéÖ', title: 'Santa Fact', content: 'Santa has over 2 billion children to visit on Christmas Eve!' },
      { icon: 'ü¶å', title: 'Reindeer Fact', content: 'Rudolph was almost named Rollo or Reginald!' },
      { icon: 'üç™', title: 'Cookie Recipe', content: 'Santa\'s favorite cookies are chocolate chip with a glass of cold milk!' },
      { icon: '‚õÑ', title: 'Snowman Joke', content: 'What do snowmen eat for breakfast? Frosted Flakes!' },
      { icon: 'üéÑ', title: 'Tree Fact', content: 'The tradition of Christmas trees started in Germany over 400 years ago!' },
      { icon: 'üéÅ', title: 'Gift Fact', content: 'The biggest Christmas gift ever was the Statue of Liberty from France!' },
      { icon: 'üîî', title: 'Jingle Bells', content: 'Jingle Bells was originally written for Thanksgiving, not Christmas!' },
      { icon: 'üßù', title: 'Elf Fact', content: 'Santa\'s elves work in 8-hour shifts around the clock making toys!' },
      { icon: '‚ú®', title: 'North Pole Fact', content: 'The North Pole temperature can drop to -40¬∞F in winter!' },
      { icon: 'üéÖ', title: 'Santa\'s Age', content: 'Santa Claus is over 1,750 years old!' },
      { icon: 'ü•õ', title: 'Milk & Cookies', content: 'Children around the world leave out over 500 million cookies for Santa!' },
      { icon: 'üéµ', title: 'Carol Fact', content: 'Silent Night has been translated into over 300 languages!' },
      { icon: '‚≠ê', title: 'Christmas Star', content: 'The star on top of the tree represents the Star of Bethlehem!' },
      { icon: 'üß¶', title: 'Stocking Fact', content: 'The tradition of stockings came from a generous gift from St. Nicholas!' },
      { icon: 'üé™', title: 'Toy Fact', content: 'The most popular toy requested from Santa is LEGO bricks!' },
      { icon: '‚ùÑÔ∏è', title: 'Snow Fact', content: 'No two snowflakes are exactly alike!' },
      { icon: 'üç¨', title: 'Candy Cane', content: 'Candy canes were originally made to keep children quiet in church!' },
      { icon: 'üé∫', title: 'Music Fact', content: 'The song "Jingle Bells" was the first song played in space!' },
      { icon: 'üåü', title: 'Wish Upon a Star', content: 'Santa grants wishes to children who believe with all their heart!' },
      { icon: 'üéâ', title: 'Celebration', content: 'Over 2 billion people celebrate Christmas worldwide!' },
      { icon: 'üïØÔ∏è', title: 'Candle Fact', content: 'Candles on Christmas trees were used before electric lights!' },
      { icon: 'üéÄ', title: 'Wrapping Fact', content: 'Americans spend over $2 billion on Christmas wrapping paper!' },
      { icon: 'üè†', title: 'Gingerbread', content: 'Gingerbread houses started in Germany in the 1800s!' },
      { icon: 'üéä', title: 'Almost Christmas!', content: 'Only 1 day left! Santa is packing his sleigh right now!' },
      { icon: 'üéÖ', title: 'MERRY CHRISTMAS!', content: 'It\'s Christmas Day! Santa visited last night while you were sleeping! üéÑ‚ú®' }
    ];

    function initAdventCalendar() {
      const grid = document.getElementById('adventGrid');
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentDay = now.getDate();
      
      // Get opened days from localStorage
      const openedDays = JSON.parse(localStorage.getItem('adventOpened') || '[]');
      
      for (let day = 1; day <= 25; day++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'advent-day';
        
        const isOpened = openedDays.includes(day);
        const isDecember = currentMonth === 11; // December is month 11
        const canOpen = isDecember && currentDay >= day;
        const isToday = isDecember && currentDay === day;
        
        if (!canOpen) {
          dayDiv.classList.add('locked');
        } else if (isOpened) {
          dayDiv.classList.add('opened');
        }
        
        if (isToday && !isOpened) {
          dayDiv.classList.add('today');
        }
        
        dayDiv.innerHTML = `
          <div class="advent-number">${day}</div>
          <div class="advent-icon">${isOpened ? '‚ú®' : canOpen ? 'üéÅ' : 'üîí'}</div>
        `;
        
        if (canOpen && !isOpened) {
          dayDiv.onclick = () => openAdventDay(day);
        }
        
        grid.appendChild(dayDiv);
      }
    }

    function openAdventDay(day) {
      const surprise = adventSurprises[day - 1];
      const modal = document.getElementById('adventModal');
      const content = document.getElementById('adventSurpriseContent');
      
      content.innerHTML = `
        <div class="advent-surprise">${surprise.icon}</div>
        <h2 style="font-size: 28px; font-weight: bold; color: #dc2626; margin-bottom: 12px;">Day ${day}</h2>
        <h3 style="font-size: 22px; font-weight: 600; color: #16a34a; margin-bottom: 16px;">${surprise.title}</h3>
        <p style="font-size: 18px; color: #374151; line-height: 1.6;">${surprise.content}</p>
        <button onclick="closeAdventModal()" style="margin-top: 24px; padding: 12px 32px; background: linear-gradient(135deg, #dc2626, #16a34a); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer;">
          Close
        </button>
      `;
      
      modal.classList.add('open');
      
      // Mark as opened
      const openedDays = JSON.parse(localStorage.getItem('adventOpened') || '[]');
      if (!openedDays.includes(day)) {
        openedDays.push(day);
        localStorage.setItem('adventOpened', JSON.stringify(openedDays));
      }
      
      // Refresh calendar to show opened state
      document.getElementById('adventGrid').innerHTML = '';
      initAdventCalendar();
    }

    function closeAdventModal() {
      document.getElementById('adventModal').classList.remove('open');
    }

    // Initialize advent calendar when page loads
    initAdventCalendar();

    /**************  CHAT WITH SANTA  **************/
    let chatHistory = [];

    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      // Get child's name from top input
      const childName = document.getElementById('childName').value.trim() || 'friend';
      
      // Add user message to chat
      addChatMessage(message, 'user');
      input.value = '';
      
      // Disable send button
      const sendBtn = document.getElementById('chatSendBtn');
      sendBtn.disabled = true;
      
      // Show typing indicator
      showTypingIndicator();
      
      try {
        // Call our backend API
        const response = await fetch('/api/santa-chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: message,
            childName: childName,
            chatHistory: chatHistory
          })
        });
        
        if (!response.ok) {
          throw new Error(`API Error: ${response.status}`);
        }
        
        const data = await response.json();
        const santaReply = data.reply;
        
        // Update chat history
        chatHistory.push({ role: 'user', content: message });
        chatHistory.push({ role: 'assistant', content: santaReply });
        
        // Remove typing indicator
        removeTypingIndicator();
        
        // Add Santa's response
        addChatMessage(santaReply, 'santa');
        
      } catch (error) {
        console.error('Chat error:', error);
        removeTypingIndicator();
        addChatMessage("Ho ho ho! My magic crystal ball is a bit foggy right now. Can you try asking me again?", 'santa');
      }
      
      // Re-enable send button
      sendBtn.disabled = false;
    }

    function addChatMessage(text, sender) {
      const messagesDiv = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${sender}`;
      
      const avatar = sender === 'santa' ? 'üéÖ' : 'üë§';
      
      messageDiv.innerHTML = `
        <div class="chat-avatar">${avatar}</div>
        <div class="chat-bubble">${text}</div>
      `;
      
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showTypingIndicator() {
      const messagesDiv = document.getElementById('chatMessages');
      const typingDiv = document.createElement('div');
      typingDiv.className = 'chat-message santa';
      typingDiv.id = 'typingIndicator';
      typingDiv.innerHTML = `
        <div class="chat-avatar">üéÖ</div>
        <div class="chat-bubble">
          <div class="chat-typing">
            <div class="chat-typing-dot"></div>
            <div class="chat-typing-dot"></div>
            <div class="chat-typing-dot"></div>
          </div>
        </div>
      `;
      messagesDiv.appendChild(typingDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function removeTypingIndicator() {
      const indicator = document.getElementById('typingIndicator');
      if (indicator) indicator.remove();
    }

    /**************  SANTA CAM  **************/
    let camManifest = null;

    async function loadCamManifest() {
      if (camManifest) return camManifest;
      const res = await fetch('/videos/index.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to load videos manifest');
      camManifest = await res.json();
      return camManifest;
    }

    async function openCam(key) {
      const modal = document.getElementById('videoModal');
      const video = document.getElementById('modalVideo');
      const title = document.getElementById('modalTitle');
      const muteBtn = document.getElementById('muteBtn');

      const manifest = await loadCamManifest();
      const scene = manifest[key];
      if (!scene || !Array.isArray(scene.files) || scene.files.length === 0) {
        alert('No videos found for this scene yet.');
        return;
      }

      const choice = scene.files[Math.floor(Math.random() * scene.files.length)];
      const src = `${(scene.base || '').replace(/\/$/, '')}/${choice}`;

      try { video.pause(); } catch {}
      video.removeAttribute('src');
      video.innerHTML = '';
      video.load();

      const source = document.createElement('source');
      source.src = src;
      source.type = 'video/mp4';
      video.appendChild(source);

      title.textContent = scene.title || 'Santa Cam';
      video.muted = false;
      muteBtn.textContent = 'üîä Mute';
      modal.classList.add('open');

      video.play().catch(() => {
        video.muted = true;
        muteBtn.textContent = 'üîá Unmute';
        video.play().catch(() => {
          alert('This video format may not be supported by the browser.');
        });
      });

      video.onerror = () => {
        console.warn('Video error; check path/codec:', src);
      };
    }

    function toggleMute() {
      const video = document.getElementById('modalVideo');
      const muteBtn = document.getElementById('muteBtn');
      video.muted = !video.muted;
      muteBtn.textContent = video.muted ? 'üîá Unmute' : 'üîä Mute';
    }

    function restartVideo() {
      const video = document.getElementById('modalVideo');
      video.currentTime = 0;
      video.play().catch(()=>{});
    }

    function closeModal() {
      const modal = document.getElementById('videoModal');
      const video = document.getElementById('modalVideo');
      try { video.pause(); } catch {}
      modal.classList.remove('open');
    }

    document.getElementById('videoModal').addEventListener('click', (e) => {
      if (e.target.id === 'videoModal') closeModal();
    });
  </script>
</body>
</html>
